import Navbar from "../components/Nabvar";
import Footer from "../components/Footer";
import { getCookieValue } from "../utils";
import { createElement, useEffect, useState } from "react";
import { useParams } from "react-router-dom";
import Button from "../components/Button";
import Typewriter from 'typewriter-effect';
import { CountdownCircleTimer } from "react-countdown-circle-timer";
import QuizButton from "../components/quizpage/QuizButton";
import BackButton from "../components/quizpage/BackButton";
import Timer from "../components/quizpage/Timer";
import ProgressBar from "../components/quizpage/ProgressBar";

function QuizPage(){

    let [countdownNum, setCountdownNum] = useState(3)
    let [scale, setScale] = useState(20)
    let [transition, setTransition] = useState(false)
    let [hideCountdown, setHideCountdown] = useState(false)
    let [quizObject, setQuizObject] = useState({})
    let [questionNumber, setQuestiobNumber] = useState(1)
    let [answers, setAnswers] = useState([])
    let [timer, setTimer] = useState(15)
    let [totalScore, setTotalScore] = useState(0)
    let [confirmButtonExtraProperties, setConfirmButtonExtraProperties] = useState("opacity-0")
    let [selectedButtonValue, setSelectedButtonValue] = useState(null)
    let [confirmButtonLabel, setConfirmButtonLabel] = useState("Confirm")
    let [startTimer, setStartTimer] = useState(false)
    let [isResultPage, setIsResultPage] = useState(false)

    const correctAnswer = quizObject.questions?.[`Slide${questionNumber}`].CorrectAnswer
    let {id} = useParams()

    useEffect(() => {
        document.body.classList.add("overflow-hidden")

        return (() => {document.body.classList.remove("overflow-hidden")})
    })

    useEffect(() => {
            if (timer != 0 && startTimer){
                setTimeout(() => {setTimer(timer - 1)}, 1000)
            }        
    }, [timer, startTimer])
    
    useEffect(() => {
        setTimeout(() => {setStartTimer(true)}, 4000)
        getQuizById(id, setQuizObject)
        setTimeout(() => {setCountdownNum(2)}, 1000)
        setTimeout(() => {setCountdownNum(1)}, 2000)
        setTimeout(() => {setCountdownNum("GO !")}, 3000)
        setTimeout(() => {setHideCountdown(true)}, 4000)
    }, [])

    useEffect(() => {
        setScale(20)
        setTransition(true)
        setTimeout(() => {setScale(75)}, 300)
        setTimeout(() => {setTransition(false)}, 300)
        
    }, [countdownNum])

    useEffect(() => {
        setAnswers(getAnswers(questionNumber))
    }, [hideCountdown])

    
    function getAnswers(questionNumber){
        let theArray = []
        theArray.push(quizObject.questions?.[`Slide${questionNumber}`].CorrectAnswer)
        theArray.push(quizObject.questions?.[`Slide${questionNumber}`].WrongAnswer1)
        theArray.push(quizObject.questions?.[`Slide${questionNumber}`].WrongAnswer2)
        theArray.push(quizObject.questions?.[`Slide${questionNumber}`].WrongAnswer3)

        for (let i = 0; i < theArray.length; i++){
            let randomNum = Math.floor(Math.random() * 3)
            if (randomNum != i){
                [theArray[i], theArray[randomNum]] = [theArray[randomNum], theArray[i]] 
            }
        }
        return(theArray)
    }

    function handleQuizButtonClick(e) {
        let x = e.clientX - e.currentTarget.offsetLeft
        let y = e.clientY - e.currentTarget.offsetTop
        let ripple = document.createElement("span")
        ripple.className = ` h-2 w-2 bg-white absolute rounded-full animate-ripple`  
        ripple.style.left = `${x}px`
        ripple.style.top = `${y}px`
        ripple.style.animation = "ripple 600ms ease-out"
        e.currentTarget.appendChild(ripple)
        setTimeout(() => {ripple.remove()}, 600)
        setConfirmButtonExtraProperties("animate-fadeIn")
    }

    function handleConfirmButtonClick() {
        if (selectedButtonValue != null && !isResultPage) {
            setIsResultPage(true)
        }
    }

    function handleQuizButtonState(answer, correctAnswer, isResultPage, selectedButtonValue){
        if (isResultPage && answer == correctAnswer){
            return("correct")
        }
        if (isResultPage && answer != correctAnswer && answer == selectedButtonValue){
            return("wrrong")
        }
        else {
            return("normal")
        }
    }




    return(
        <>
            <style>
            </style>
            <div className="w-[200vw] aspect-square bg-[#5D688A]  rounded-full absolute top-[-120vw] md:top-[-170vw] left-[-50vw]  origin-center"></div> {/** semi cercle */}
            <div className="h-[100vh] bg-[#374060] flex justify-evenly items-center flex-col" id="main">
                <div className="z-10 w-[80vw] md:w-[45vw] h-[15vh] origin-center">
                    <div className="w-full h-[70%] flex justify-between items-center">
                        <BackButton></BackButton>
                        <div className="text-white">{`${questionNumber} of ${quizObject.slidesNum}`}</div>
                        <Timer time={timer}></Timer>
                    </div>
                    <div className="w-full h-[30%] flex items-center justify-center">
                        <ProgressBar currentSlideNum={questionNumber} totalSlideNum={quizObject.slidesNum}></ProgressBar>
                    </div>
                </div> { /**  timer progress bar and exit button */ }
                <div className="h-[65vh] w-[80vw] bg-white z-2 rounded-4xl flex justify-center   items-center shadow-md max-w-[785px]">
                    <div className={`text-black text-9xl  ${hideCountdown ? "hidden" : ""}`} style={{transform: `scale(${scale / 100})`, transition: transition ? "none" : "transform 0.7s ease", transformOrigin: "center center"}}>{countdownNum}</div>
                    <div className={`flex flex-col w-[75%] h-full justify-around items-center ${hideCountdown ? "" : "hidden" }`}>
                        <div className="text-black text-xl z-3">{quizObject.questions && <Typewriter onInit={(typewriter) => {typewriter.pauseFor(4000).typeString(`${quizObject.questions?.[`Slide${questionNumber}`].Question}`).start()}} options={{cursor: "", delay: 50}}></Typewriter>}</div>
                        <div className={`flex justify-evenly w-[75%] h-[50%] flex-wrap items-evenly` }>{answers.map((answer) => <QuizButton label={answer} onclick={handleQuizButtonClick} state={"normal"} setSelectedButtonValue={setSelectedButtonValue} quizButtonExtraProperties={selectedButtonValue != null && selectedButtonValue != answer ? "animate-buttonFadeOut" : ""}></QuizButton>)}</div>
                    </div>
                </div> {/** quiz area*/}
                <Button className={confirmButtonExtraProperties} name={confirmButtonLabel}></Button>
                <button onClick={() => {console.log(selectedButtonValue)}}>hello</button>
            </div>
            
        </>
    )
}
export default QuizPage


async function getQuizById(id, setFunc){
    let response = await fetch(`http://localhost:5001/getquizbyid?id=${id}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
        },
    })
    let quizObj = await response.json()
    setFunc(quizObj)
}



